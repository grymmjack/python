name: Release (PyInstaller)

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ["3.12"]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install PySide6 pyinstaller

      - name: Clean build output
        shell: bash
        run: |
          rm -rf build dist

      # âœ… macOS runners have `sips` + `iconutil`. Generate icon.icns here.
      - name: Generate macOS .icns
        if: runner.os == 'macOS'
        shell: bash
        run: |
          mkdir -p /tmp/icon.iconset
          sips -z 16 16     assets/icon.png --out /tmp/icon.iconset/icon_16x16.png
          sips -z 32 32     assets/icon.png --out /tmp/icon.iconset/icon_16x16@2x.png
          sips -z 32 32     assets/icon.png --out /tmp/icon.iconset/icon_32x32.png
          sips -z 64 64     assets/icon.png --out /tmp/icon.iconset/icon_32x32@2x.png
          sips -z 128 128   assets/icon.png --out /tmp/icon.iconset/icon_128x128.png
          sips -z 256 256   assets/icon.png --out /tmp/icon.iconset/icon_128x128@2x.png
          sips -z 256 256   assets/icon.png --out /tmp/icon.iconset/icon_256x256.png
          sips -z 512 512   assets/icon.png --out /tmp/icon.iconset/icon_256x256@2x.png
          sips -z 512 512   assets/icon.png --out /tmp/icon.iconset/icon_512x512.png
          sips -z 1024 1024 assets/icon.png --out /tmp/icon.iconset/icon_512x512@2x.png
          iconutil -c icns /tmp/icon.iconset -o assets/icon.icns
          ls -la assets/icon.icns

      - name: Build (spec)
        run: |
          pyinstaller --noconfirm --clean test1.spec

      - name: Package release asset
        shell: bash
        run: |
          python - <<'PY'
          import os, re, zipfile, pathlib, platform

          APP = "test1"
          tag = os.environ.get("GITHUB_REF_NAME", "v0.0.0")

          m = re.match(r"^v(\d+\.\d+\.\d+.*)$", tag)
          ver = m.group(1) if m else tag

          runner_os = os.environ.get("RUNNER_OS", "").lower()
          if runner_os.startswith("windows"):
              os_name = "windows"
          elif runner_os.startswith("mac"):
              os_name = "macos"
          else:
              os_name = "linux"

          arch = platform.machine().lower()
          if arch in ("x86_64", "amd64"):
              arch = "x64"
          elif arch in ("aarch64", "arm64"):
              arch = "arm64"

          dist = pathlib.Path("dist")
          if not dist.exists():
              raise SystemExit("dist/ does not exist; build likely failed.")

          out_name = f"{APP}_{ver}_{os_name}_{arch}.zip"
          out_path = pathlib.Path(out_name)

          def add_path(zf: zipfile.ZipFile, p: pathlib.Path, arcbase: str):
              if p.is_dir():
                  for f in p.rglob("*"):
                      if f.is_file():
                          zf.write(f, f"{arcbase}/{f.relative_to(p)}")
              else:
                  zf.write(p, f"{arcbase}/{p.name}")

          targets = []
          app_bundle = dist / f"{APP}.app"
          if app_bundle.exists():
              targets = [app_bundle]
          else:
              exe = dist / (APP + (".exe" if os_name == "windows" else ""))
              targets = [exe] if exe.exists() else list(dist.iterdir())

          with zipfile.ZipFile(out_path, "w", compression=zipfile.ZIP_DEFLATED) as zf:
              for t in targets:
                  add_path(zf, t, "dist")

          print(f"Created {out_path}")
          PY

      - name: Upload build artifact (for Release job)
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ runner.os }}
          path: test1_*.zip

  release:
    name: Create GitHub Release + upload assets
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Publish Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/**/test1_*.zip
          generate_release_notes: true

